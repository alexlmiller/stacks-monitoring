# Stacks Monitoring - Full Stack
#
# Deploy a complete monitoring stack including:
# - Alloy (log receiver and processor)
# - VictoriaMetrics (metrics storage)
# - VictoriaLogs (log storage)
# - Grafana (dashboards and alerting)
#
# Usage:
#   cp .env.example .env
#   docker-compose up -d
#   open http://localhost:3000

version: '3.8'

services:
  # ===========================================================================
  # Alloy - Log receiver and processor
  # ===========================================================================
  alloy:
    image: grafana/alloy:latest
    container_name: stacks-alloy-hub
    restart: unless-stopped
    volumes:
      - ../alloy/examples/monitoring-hub-complete.alloy:/etc/alloy/config.alloy:ro
      - alloy_data:/var/lib/alloy
    environment:
      - LOGS_TARGET_URL=http://victorialogs:9428/insert/loki/api/v1/push?_stream_fields=job,host,service,level
      - METRICS_TARGET_URL=http://victoriametrics:8428/api/v1/write
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    ports:
      - "12345:12345"  # Alloy UI
      - "3500:3500"    # Loki receiver (for remote agents)
      - "9091:9091"    # Prometheus receiver (for remote agents)
    networks:
      - stacks-monitoring
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:12345/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # VictoriaMetrics - Metrics storage (Prometheus-compatible)
  # ===========================================================================
  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: stacks-victoriametrics
    restart: unless-stopped
    volumes:
      - victoriametrics_data:/storage
    command:
      - --storageDataPath=/storage
      - --httpListenAddr=:8428
      - --retentionPeriod=${PROMETHEUS_RETENTION:-15d}
    ports:
      - "8428:8428"
    networks:
      - stacks-monitoring
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # VictoriaLogs - Log storage (Loki-compatible)
  # ===========================================================================
  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: stacks-victorialogs
    restart: unless-stopped
    volumes:
      - victorialogs_data:/storage
    command:
      - --storageDataPath=/storage
      - --httpListenAddr=:9428
      - --retentionPeriod=${VICTORIALOGS_RETENTION:-4w}
    ports:
      - "9428:9428"
    networks:
      - stacks-monitoring
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9428/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Grafana - Dashboards and visualization
  # ===========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: stacks-grafana
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
      - ../grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ../grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL:-http://localhost:3000}
      - GF_USERS_ALLOW_SIGN_UP=false
      # Datasource provisioning via environment
      - GF_INSTALL_PLUGINS=victoriametrics-logs-datasource,victoriametrics-metrics-datasource
    ports:
      - "3000:3000"
    networks:
      - stacks-monitoring
    depends_on:
      - victoriametrics
      - victorialogs
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  stacks-monitoring:
    driver: bridge

volumes:
  alloy_data:
    driver: local
  victoriametrics_data:
    driver: local
  victorialogs_data:
    driver: local
  grafana_data:
    driver: local
