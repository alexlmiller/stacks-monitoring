groups:
  - name: stacks-pox
    rules:
      # =========================================================================
      # POX EXPORTER HEALTH
      # =========================================================================

      - alert: StacksPoXExporterDown
        expr: up{service="pox-exporter"} == 0
        for: 5m
        labels:
          severity: warning
          service: pox-exporter
        annotations:
          summary: "PoX cycle exporter is down"
          description: "Cannot scrape PoX metrics from {{ $labels.host }} - stacking deadline alerts unavailable."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#pox-exporter-down"

      - alert: StacksPoXApiUnreachable
        expr: stacks_pox_up == 0
        for: 5m
        labels:
          severity: warning
          service: pox-exporter
        annotations:
          summary: "Cannot reach Stacks node PoX API"
          description: "The PoX exporter on {{ $labels.host }} cannot reach the Stacks node /v2/pox endpoint."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#pox-api-unreachable"

      # =========================================================================
      # STACKING DEADLINE REMINDERS
      # These alerts incorporate registration status when STACKER_ADDRESSES is
      # configured in the PoX exporter. If not configured, they fall back to
      # time-based warnings only.
      # =========================================================================

      - alert: StacksRestackReminder
        # Fires when approaching deadline AND not registered for next cycle
        # If registration checking is disabled (-1), only the time-based alert fires
        expr: |
          stacks_pox_blocks_until_prepare_phase > 0
          and stacks_pox_blocks_until_prepare_phase < 720
          and stacks_pox_registered_next_cycle == 0
        for: 5m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "Stacks: ~5 days until prepare phase - not registered"
          description: "{{ $value | printf \"%.0f\" }} blocks until prepare phase and you are NOT registered for the next cycle. Restack soon to avoid missing rewards."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#restack-reminder"

      - alert: StacksRestackUrgent
        # Fires when deadline imminent AND not registered for next cycle
        expr: |
          stacks_pox_blocks_until_prepare_phase > 0
          and stacks_pox_blocks_until_prepare_phase < 144
          and stacks_pox_registered_next_cycle == 0
        for: 5m
        labels:
          severity: critical
          service: stacks-signer
        annotations:
          summary: "URGENT: ~1 day until prepare phase - not registered"
          description: "Only {{ $value | printf \"%.0f\" }} blocks until prepare phase and you are NOT registered for the next cycle. Restack NOW to avoid missing rewards."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#restack-urgent"

      # =========================================================================
      # FALLBACK ALERTS (when registration checking is disabled)
      # These fire if STACKER_ADDRESSES is not configured
      # =========================================================================

      - alert: StacksRestackReminderNoCheck
        # Fallback: fires when registration checking is disabled
        expr: |
          stacks_pox_blocks_until_prepare_phase > 0
          and stacks_pox_blocks_until_prepare_phase < 720
          and stacks_pox_registered_next_cycle == -1
        for: 10m
        labels:
          severity: info
          service: stacks-signer
        annotations:
          summary: "Stacks: ~5 days until prepare phase (registration check disabled)"
          description: "{{ $value | printf \"%.0f\" }} blocks until prepare phase. Configure STACKER_ADDRESSES in the PoX exporter to enable automatic registration checking."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#restack-reminder"
