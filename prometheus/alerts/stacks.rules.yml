groups:
  - name: stacks-signer
    rules:
      # =========================================================================
      # CRITICAL ALERTS
      # =========================================================================

      - alert: StacksSignerDown
        expr: up{service="stacks-signer"} == 0
        for: 3m
        labels:
          severity: critical
          service: stacks-signer
        annotations:
          summary: "Stacks Signer is down"
          description: "Stacks signer metrics endpoint on {{ $labels.host }} has been unreachable for more than 3 minutes. The signer process may have crashed."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#signer-down"

      # =========================================================================
      # WARNING ALERTS
      # =========================================================================

      - alert: StacksSignerHighRejection
        expr: |
          (
            sum by (host) (rate(stacks_signer_block_responses_sent{response_type="rejected"}[5m]))
            /
            sum by (host) (rate(stacks_signer_block_responses_sent[5m]))
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "High block rejection rate on Stacks Signer"
          description: "Signer on {{ $labels.host }} is rejecting more than 50% of block proposals. Current rejection rate: {{ $value | humanizePercentage }}."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#high-rejection"

      - alert: StacksSignerNotRegistered
        expr: stacks_signer_is_registered == 0
        for: 5m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "Stacks Signer not registered for current cycle"
          description: "Signer on {{ $labels.host }} is not registered for the current reward cycle. This may indicate a configuration issue or that the signer hasn't been set up for stacking."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#not-registered"

      - alert: StacksSignerStateConflicts
        expr: increase(stacks_signer_agreement_state_conflicts[5m]) > 0
        for: 0m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "Stacks Signer state conflicts detected"
          description: "Signer on {{ $labels.host }} has detected {{ $value }} state machine conflicts in the last 5 minutes. This may indicate consensus issues."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#state-conflicts"

      - alert: StacksSignerSlowResponse
        expr: |
          histogram_quantile(0.95,
            sum by (host, le) (rate(stacks_signer_block_response_latencies_histogram_bucket[5m]))
          ) > 60
        for: 5m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "Stacks Signer responding slowly to block proposals"
          description: "95th percentile response latency for signer on {{ $labels.host }} is above 60 seconds ({{ $value | humanizeDuration }}). This may cause missed signing opportunities."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#slow-response"

  - name: stacks-node
    rules:
      - alert: StacksNodeLowPeers
        expr: stacks_node_peer_count < 10
        for: 10m
        labels:
          severity: warning
          service: stacks-node
        annotations:
          summary: "Stacks Node has low peer count"
          description: "Stacks node on {{ $labels.host }} has only {{ $value }} peers connected. Low peer count may affect block propagation and network participation."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#low-peers"

      - alert: StacksNodeDown
        expr: up{service="stacks-node"} == 0
        for: 3m
        labels:
          severity: critical
          service: stacks-node
        annotations:
          summary: "Stacks Node is down"
          description: "Stacks node metrics endpoint on {{ $labels.host }} has been unreachable for more than 3 minutes."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#node-down"

  # ===========================================================================
  # NETWORK ALERTS - Issues with the Stacks network (wait for recovery)
  # ===========================================================================
  - name: stacks-network
    rules:
      # -------------------------------------------------------------------------
      # Block Production Monitoring - Early warning system for network stalls
      # -------------------------------------------------------------------------

      - alert: StacksBlockProductionDegraded
        # Early warning: fires 10-15 minutes before full stall
        # Normal production: 25-35 blocks per 5 minutes
        # This catches 50% degradation (5-20 blocks/5min)
        expr: |
          increase(stacks_node_stacks_tip_height[5m]) < 20
          and
          increase(stacks_node_stacks_tip_height[5m]) > 5
        for: 3m
        labels:
          severity: warning
          service: stacks-node
          issue_type: network
        annotations:
          summary: "Early warning: block production at 50% of normal"
          description: "Block production at {{ $value | printf \"%.0f\" }} blocks/5min (normal: 25-35). This is an EARLY WARNING of potential network issues. Check https://explorer.hiro.so for network-wide status."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#block-production"

      - alert: StacksBlockProductionIssues
        # More severe: less than 5 blocks in 5 minutes
        expr: increase(stacks_node_stacks_tip_height[5m]) < 5
        for: 5m
        labels:
          severity: warning
          service: stacks-node
          issue_type: network
        annotations:
          summary: "Block production severely degraded"
          description: "Only {{ $value | printf \"%.0f\" }} blocks produced in last 5 minutes (normal: 25-35). Block production is degraded but not halted. Check Stacks Discord for network status."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#block-production"

      - alert: StacksBlockStall
        # Complete stall: derivative approaches zero
        expr: |
          deriv(stacks_node_stacks_tip_height[10m]) < 0.001
          and
          deriv(stacks_node_stacks_tip_height[10m]) > -0.001
        for: 5m
        labels:
          severity: warning
          service: stacks-node
          issue_type: network
        annotations:
          summary: "Block production stalled - no new blocks"
          description: "No new Stacks blocks produced in 5+ minutes (rate={{ $value | printf \"%.4f\" }} blocks/sec). This may indicate a network-wide consensus stall. Check Stacks Discord/Twitter for network status."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#block-stall"

      # -------------------------------------------------------------------------
      # Signer Network Indicators
      # -------------------------------------------------------------------------

      - alert: StacksSignerHighRejectionCount
        # Absolute count of rejections (complements rate-based alert)
        # Normal baseline: ~6 rejections per 10 minutes
        expr: increase(stacks_signer_block_responses_sent{response_type="rejected"}[10m]) > 50
        for: 5m
        labels:
          severity: warning
          service: stacks-signer
          issue_type: network
        annotations:
          summary: "High block rejection count"
          description: "Signer rejected {{ $value | printf \"%.0f\" }} blocks in 10 minutes (normal: ~6). High rejection count indicates consensus issues or network stall. Check Stacks Discord for network status."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#high-rejection"

      - alert: StacksSignerHighProposalRate
        # High proposal rate indicates miner competition or network congestion
        # Normal baseline: ~0.23 proposals per second
        expr: rate(stacks_signer_block_proposals_received[5m]) > 0.8
        for: 10m
        labels:
          severity: info
          service: stacks-signer
          issue_type: network
        annotations:
          summary: "High block proposal rate"
          description: "Receiving {{ $value | printf \"%.2f\" }} block proposals/sec (normal: ~0.23/s). High proposal rate indicates miner competition or network congestion."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#high-proposals"

  - name: bitcoin-node
    rules:
      - alert: BitcoinBlockStall
        expr: (time() - stacks_node_burn_block_timestamp) > 1800
        for: 5m
        labels:
          severity: warning
          service: bitcoin-node
        annotations:
          summary: "No new Bitcoin blocks for 30 minutes"
          description: "No new Bitcoin block has been seen by the node on {{ $labels.host }} for over 30 minutes. This could indicate network issues or Bitcoin network congestion."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#bitcoin-stall"

      - alert: BitcoinNodeDown
        expr: up{service="bitcoin-node"} == 0
        for: 3m
        labels:
          severity: critical
          service: bitcoin-node
        annotations:
          summary: "Bitcoin Node is down"
          description: "Bitcoin node metrics endpoint on {{ $labels.host }} has been unreachable for more than 3 minutes."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#bitcoin-down"

      - alert: BitcoinLowPeers
        # Stacks depends on Bitcoin for anchor blocks
        # Low peer count may cause slow block propagation
        expr: (bitcoin_conn_in + bitcoin_conn_out) < 4
        for: 15m
        labels:
          severity: warning
          service: bitcoin-node
        annotations:
          summary: "Bitcoin node has low peer count"
          description: "Bitcoin node has only {{ $value | printf \"%.0f\" }} peer connections (threshold: 4). Low peer count may cause slow block propagation. Check network connectivity and firewall rules."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#bitcoin-low-peers"

  - name: stacks-logs
    rules:
      # Log-based alerts (requires recording rules or log metrics)
      # These require either:
      # 1. Loki alerting rules (separate config)
      # 2. log_entries_total metric from Alloy
      # 3. VictoriaLogs alerting

      - alert: StacksSignerLogSilence
        # This alert requires a log count metric
        # If using Alloy with metrics, you can create a recording rule
        # Otherwise, configure this in Loki/VictoriaLogs alerting
        expr: |
          absent_over_time(
            {service="stacks-signer"}[3m]
          )
        for: 0m
        labels:
          severity: warning
          service: stacks-signer
        annotations:
          summary: "No Stacks Signer logs for 3 minutes"
          description: "No logs have been received from stacks-signer on {{ $labels.host }} for 3 minutes. The signer may be down or log collection may be broken."
          runbook_url: "https://github.com/alexlmiller/stacks-monitoring/blob/main/docs/TROUBLESHOOTING.md#log-silence"
